<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Control Sensitizing Tool</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; max-width: 900px; }
    .row { margin: 12px 0; }
    input[type="text"] { padding: 6px 10px; width: 320px; }
    button { padding: 8px 12px; cursor: pointer; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space: pre-wrap; }
    img { max-width: 100%; border: 1px solid #ddd; border-radius: 8px; }
  </style>
</head>

<body>
  <h1>Control Sensitizing Graph</h1>

  <div class="row">
    <input id="file" type="file" accept=".csv,text/csv" />
  </div>

  <div class="row">
    <label for="col">Column name: </label>
    <input id="col" type="text" placeholder="e.g., Absorbance" />
    <button id="run" type="button">Run</button>
  </div>

  <div class="row" id="status"></div>
  <div class="row" id="summary"></div>
  <div class="row"><img id="plot" alt="plot" /></div>
  <div class="row mono" id="log"></div>

  <!-- Load Pyodide -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>

  <script>
    console.log("SCRIPT LOADED");

    // DOM refs (set on DOMContentLoaded)
    let statusEl, summaryEl, plotEl, logEl, fileEl, colEl, runEl;

    // State
    let pyodide = null;
    let fileBytes = null;

    function setStatus(msg) { statusEl.textContent = msg; }
    function setLog(msg) { logEl.textContent = msg; }

    async function initPyodide() {
      try {
        setStatus("Loading Python runtime (Pyodide)...");
        pyodide = await loadPyodide();

        setStatus("Loading Python packages (pandas, matplotlib)...");
        await pyodide.loadPackage(["pandas", "matplotlib"]);

        setStatus("Fetching control.py...");
        // Cache-bust to avoid stale GitHub Pages caching during development
        const resp = await fetch("control.py?v=" + Date.now());
        if (!resp.ok) throw new Error(`Failed to fetch control.py: ${resp.status} ${resp.statusText}`);
        const pyCode = await resp.text();
        console.log("Loaded control.py length:", pyCode.length);

        setStatus("Loading Python code...");
        pyodide.runPython(pyCode);

        // Sanity check: ensure function exists
        const hasFn = pyodide.runPython(`'controlSensitizingGraph' in globals()`);
        if (!hasFn) throw new Error("controlSensitizingGraph was not defined after running control.py");

        setStatus("Ready. Upload a CSV and enter a column name.");
      } catch (err) {
        setStatus("Error during init.");
        setLog(err?.stack || String(err));
        console.error(err);
      }
    }

    async function handleFileChange(e) {
      const f = e.target.files?.[0];
      if (!f) return;
      const arr = new Uint8Array(await f.arrayBuffer());
      fileBytes = arr;
      setStatus(`Loaded: ${f.name} (${arr.byteLength.toLocaleString()} bytes)`);
      console.log("FILE CHANGED");
    }

    async function handleRunClick() {
      summaryEl.textContent = "";
      plotEl.removeAttribute("src");
      setLog("");

      try {
        console.log("RUN CLICKED");

        if (!pyodide) throw new Error("Pyodide not initialized yet.");
        if (!fileBytes) throw new Error("Please upload a CSV first.");

        const col = colEl.value.trim();
        if (!col) throw new Error("Please enter a column name.");

        setStatus("Running analysis...");

        pyodide.globals.set("file_bytes", fileBytes);
        pyodide.globals.set("output_col", col);

        const pyOut = pyodide.runPython(`
controlSensitizingGraph(bytes(file_bytes), output_col)
        `);

        console.log("Raw Python return:", pyOut);

        const result = pyOut?.toJs ? pyOut.toJs({ dict_converter: Object }) : pyOut;
        console.log("JS-converted result:", result);

        // If Python returned something unexpected, show it
        if (!result || typeof result !== "object") {
          setStatus("Error.");
          setLog("Python returned non-object:\n" + String(result));
          return;
        }

        // If Python returned ok:false (or missing ok), show full object
        if (result.ok !== true) {
          setStatus("Error.");
          setLog("Python returned:\n" + JSON.stringify(result, null, 2));
          return;
        }

        setStatus("Done.");
        summaryEl.innerHTML = `
          <b>n</b>: ${result.n} &nbsp; | &nbsp;
          <b>mean</b>: ${Number(result.mean).toFixed(6)} &nbsp; | &nbsp;
          <b>std</b>: ${Number(result.std).toFixed(6)} &nbsp; | &nbsp;
          <b>flagged points</b>: ${(result.problem_points || []).length}
        `;

        if (result.plot_png_base64) {
          plotEl.src = "data:image/png;base64," + result.plot_png_base64;
        }

        const lines = [];
        for (const msg of (result.messages || [])) lines.push(msg);
        lines.push("");
        lines.push("Problem points: " + JSON.stringify(result.problem_points || []));
        setLog(lines.join("\n"));

      } catch (err) {
        setStatus("Error.");
        setLog(err?.stack || String(err));
        console.error(err);
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      console.log("DOM READY");

      statusEl = document.getElementById("status");
      summaryEl = document.getElementById("summary");
      plotEl = document.getElementById("plot");
      logEl = document.getElementById("log");
      fileEl = document.getElementById("file");
      colEl = document.getElementById("col");
      runEl = document.getElementById("run");

      console.log("runBtn:", runEl);
      console.log("fileInput:", fileEl);

      fileEl.addEventListener("change", handleFileChange);
      runEl.addEventListener("click", handleRunClick);

      initPyodide();
    });
  </script>
</body>
</html>
