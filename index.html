<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Control Sensitizing Tool</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; max-width: 900px; }
    .row { margin: 12px 0; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    input[type="text"] { padding: 6px 10px; width: 320px; }
    button { padding: 8px 12px; cursor: pointer; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space: pre-wrap; }
    img { max-width: 100%; border: 1px solid #ddd; border-radius: 8px; }
    #status { font-weight: 600; }
    .muted { opacity: 0.8; }
  </style>
</head>

<body>
  <h1>Control Sensitizing Graph</h1>

  <div class="row">
    <input id="file" type="file" accept=".csv,text/csv" />
  </div>

  <div class="row">
    <label for="col">Column name:</label>
    <input id="col" type="text" placeholder="e.g., Absorbance" />
    <button id="run" type="button" disabled>Run</button>
    <span class="muted" id="hint"></span>
  </div>

  <div class="row">
    <label for="returnCols">Extra columns to show:</label>
    <input id="returnCols" type="text" placeholder="e.g., scan_id, well" />
    <span class="muted">Comma-separated</span>
  </div>

  <div class="row" id="status">Loading...</div>
  <div class="row" id="summary"></div>
  <div class="row"><img id="plot" alt="plot" /></div>
  <div class="row mono" id="log"></div>

  <!-- Pyodide -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>

  <script>
    // DOM
    const statusEl = document.getElementById("status");
    const summaryEl = document.getElementById("summary");
    const plotEl = document.getElementById("plot");
    const logEl = document.getElementById("log");
    const fileEl = document.getElementById("file");
    const colEl = document.getElementById("col");
    const returnColsEl = document.getElementById("returnCols");
    const runEl = document.getElementById("run");
    const hintEl = document.getElementById("hint");

    // State
    let pyodide = null;
    let fileBytes = null;

    const setStatus = (msg) => statusEl.textContent = msg;
    const setLog = (msg) => logEl.textContent = msg || "";
    const clearOutput = () => {
      summaryEl.textContent = "";
      plotEl.removeAttribute("src");
      setLog("");
    };

    function updateRunEnabled() {
      const ok = !!pyodide && !!fileBytes && !!colEl.value.trim();
      runEl.disabled = !ok;
      hintEl.textContent = ok ? "" : "Upload CSV + enter column name";
    }

    async function init() {
      try {
        setStatus("Loading Python runtime (Pyodide)...");
        pyodide = await loadPyodide();

        setStatus("Loading packages (pandas, matplotlib)...");
        await pyodide.loadPackage(["pandas", "matplotlib"]);

        setStatus("Loading control.py...");
        const resp = await fetch("control.py?v=" + Date.now());
        if (!resp.ok) throw new Error(`Failed to fetch control.py: ${resp.status} ${resp.statusText}`);
        const pyCode = await resp.text();

        pyodide.runPython(pyCode);

        const hasFn = pyodide.runPython(`"controlSensitizingGraph" in globals()`);
        if (!hasFn) throw new Error("controlSensitizingGraph not found after loading control.py");

        setStatus("Ready. Upload a CSV and enter a column name.");
        updateRunEnabled();
      } catch (err) {
        setStatus("Error during init.");
        setLog(err?.stack || String(err));
        console.error(err);
      }
    }

    fileEl.addEventListener("change", async (e) => {
      clearOutput();
      const f = e.target.files?.[0];
      if (!f) { fileBytes = null; updateRunEnabled(); return; }

      const arr = new Uint8Array(await f.arrayBuffer());
      fileBytes = arr;
      setStatus(`Loaded: ${f.name} (${arr.byteLength.toLocaleString()} bytes)`);
      updateRunEnabled();
    });

    colEl.addEventListener("input", () => updateRunEnabled());

    runEl.addEventListener("click", async () => {
      clearOutput();
      try {
        if (!pyodide) throw new Error("Pyodide not ready yet.");
        if (!fileBytes) throw new Error("Upload a CSV first.");

        const col = colEl.value.trim();
        if (!col) throw new Error("Enter a column name.");

        const returnColsRaw = (returnColsEl?.value || "").trim();
        const returnCols = returnColsRaw
          ? returnColsRaw.split(",").map(s => s.trim()).filter(Boolean)
          : [];

        setStatus("Running analysis...");
        runEl.disabled = true;

        pyodide.globals.set("file_bytes", fileBytes);
        pyodide.globals.set("output_col", col);
        pyodide.globals.set("return_cols", returnCols);

        // NOTE: requires updated Python signature:
        // controlSensitizingGraph(controlDataBytes, outputCol, returnCols=None)
        const pyOut = pyodide.runPython(`
controlSensitizingGraph(bytes(file_bytes), output_col, return_cols)
        `);

        let result;
        if (pyOut?.toJs) {
          const converted = pyOut.toJs({ dict_converter: Object.fromEntries, create_proxies: false });
          pyOut.destroy?.();
          result = converted;
        } else {
          result = pyOut;
        }

        if (!result || typeof result !== "object") {
          throw new Error("Python returned unexpected output:\n" + String(result));
        }
        if (result.ok !== true) {
          throw new Error(result.error || ("Python returned:\n" + JSON.stringify(result, null, 2)));
        }

        setStatus("Done.");

        summaryEl.innerHTML = `
          <b>n</b>: ${result.n} &nbsp; | &nbsp;
          <b>mean</b>: ${Number(result.mean).toFixed(6)} &nbsp; | &nbsp;
          <b>std</b>: ${Number(result.std).toFixed(6)} &nbsp; | &nbsp;
          <b>flagged points</b>: ${(result.problem_points || []).length}
        `;

        if (result.plot_png_base64) {
          plotEl.src = "data:image/png;base64," + result.plot_png_base64;
        }

        const lines = [];
        for (const msg of (result.messages || [])) lines.push(msg);
        lines.push("");
        lines.push("Problem points: " + JSON.stringify(result.problem_points || []));

        // NEW: print extra columns for flagged points (if provided)
        const cols = result.return_cols || [];
        const meta = result.point_meta || [];
        if (cols.length) {
          lines.push("");
          lines.push("Flagged point details:");
          for (const i of (result.problem_points || [])) {
            const m = meta[i] || {};
            const details = cols.map(c => `${c}=${m[c]}`).join(", ");
            lines.push(`  Point ${i} (row ${m.row_index}): ${details}`);
          }
        }

        setLog(lines.join("\n"));

      } catch (err) {
        setStatus("Error.");
        setLog(err?.stack || String(err));
        console.error(err);
      } finally {
        updateRunEnabled();
      }
    });

    init();
  </script>
</body>
</html>
